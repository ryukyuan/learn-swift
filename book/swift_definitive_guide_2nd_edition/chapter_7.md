# 7章

## 7.2 演算子の定義

### 演算子の宣言と定義

* swiftは自分で演算子を定義することができる
* ただし、どのような演算子を定義するかによって定義方法は異なる

```
1: まったく新しい演算子を定義する
2: すでに使われている演算子に別な使い方を定義する
 a. これまで単項演算子として使われていた演算子に、二項演算子としての役割を定義する。あるいは逆
 b. これまでとは違うデータ型（の組み合わせ）に対して適用可能にする。
```

* 1:、2:-aの場合は演算子として使う記号（あるいは記号列）と使い方（前置演算子／後置演算子／二項演算子）を宣言する必要がある。この宣言はどの型や関数の定義に属さずトップレベルでグローバルに行う必要がある。
* 2:-bのように既に演算子として使われているものについては、改めて宣言する必要はない。

* Table7-3に示す演算子は新たな定義を行えない。

* 以下に二項演算子、前置演算子、後置演算子の宣言の概要を示す。
* 二項演算子のみ、オプションで優先度と結合規則を指定できる

```
■ 二項演算子
infix operator 演算子 {
    precedence 数字 // 指定しない場合は、既定値は100
    associativity 規則 // 規則はleft/right/noneのいずれか、指定しなければ既定値はnone
}

■ 前置演算子
prefix operator 演算子 {}

■ 後置演算子
postfix operator 演算子 {}
```

* 演算子の定義は関数定義とは関係なく、どこかに置かれているば良い。
* 一度、何かの目的のために宣言された演算子は、別なデータ型向けに定義（オーバーロード）することはできるが、優先度や結合規則は変えられない。
* たとえば「+」という演算子に新しい定義を付加することはできるが、「*」より高い優先度で定義し直すことはできない。

* 演算子は複数個の文字の組み合わせで構成できる。
* 先頭に使えるモイと2文字目以降に使える文字がSwiftの仕様として決められている。
* 付録Bに利用できる文字の概要が示されている。

* 演算子を機能させるためには、引数となるデータ型を指定して、演算子が行う処理を関数として定義する必要がある。
* 二項演算子の場合、左側と右側の引数が、関数ではそれぞれ第1引数、第2引数となる。* また、演算の毛化を左辺の値に代入する、複合演算子を定義することもできる。
* 単行演算子では、前置演算子か後置演算子かprefix、postfixというキーワードで指定する必要がある。


### 二項演算子の定義

* 例として演算子「〜」という文字を使い定義する。
* 整数を文字列に変換すると同時に指定した幅の文字列になるように必要な空白を追加する二項演算子を定義する。

```
print(x+f(2)〜8) // x+f(2)の演算結果を8桁の文字列にして印字する
```

```
infix operator 〜 { // 二項演算子として宣言
    precedence 20 // 他の演算子より低い優先度
    associativity none // 結合規則はなし
}

func 〜 (n:Int, w:Int) -> String {
    var str = String(n)
    let pad = w - str.characters.count // 左に詰める空白の個数
    if pad > 0 {
        str = String(count:pad, repeatedValue:Character(" ")) + str
    }
    return str
}
```

```
for var wid = 2; wid <= 6; wid += 2 {
    for i in 1...5 {
        print(i + 7 〜 wid, terminator:"")
    }
    print("")
}
```

```
_8_9101112 // 空白 1,1,0...
___8___9__10__11__12 // 空白 3,3,2...
_____8_____9____10____11____12 // 空白 5,5,4...
```


### 単行演算子の定義

* 単行演算子として定義されていなお「%」を後置演算子として宣言する例を示す。
* パーセントを表す演算子を定義する。
* 実数と整数の両方ｗ使いたいので関数を２つ定義する。
* 関数はpostfixというキーワードで修飾する。

```
postfix operator % {} // 後置演算子として定義

postfix func % (n*Int) -> Double { // postfixの指定は必須
    return 0.01 * Double(n)
}
postfix func % (r:Double) -> Double {
   return 0.01 * r
}
```

```
var price: Double = 19_800 // 19,800円に85%のOFFと8%の消費税が付いたらいくらになるか？
print(price * 85% * 108%) // 18176.4 と表示
```


### 引数の変数の値を変更するには

* インクリメント演算子や複合代入演算子のように、呼び出した側の変数の値が変化する演算子がある。
* そのような演算子の定義では、演算子の関数定義においてinout関数を使う。
* ただし、通常の関数呼び出しと異なり、呼び出す側で「&」を記述する必要はない。

* 簡単な例として、左辺の変数の実数値と右辺の実数値を比較し、右辺の方が大きければ、その値で左辺の変数値を置き換えるという演算子を作る。

```
infix operator >? { // 二項演算子として宣言
    perecedence 90 // 代入演算子と同じ優先度
    associativity noe // 結合規則はなし
}

func >? (inout lhs:Double, rhs:Double) {
    if lhs < rhs { lhs = rhs }
}
```

```
var a = 1.22
for x in [ 0.9, 1.25, -1.0, 2.0, 0.86 ] {
   a >? x // 演算子を使う。「&」は不要。
}
print(a)  // 最大値の2.0を表示。
```





